<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fed ê¸ˆë¦¬ ì „ë§ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap');
:root{--bg:#06080f;--card:#0d1117;--border:#1b2332;--accent:#3b82f6;--green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#8b5cf6;--cyan:#06b6d4;--pink:#ec4899;--text:#e2e8f0;--muted:#94a3b8;--dim:#475569}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.wrap{max-width:1100px;margin:0 auto;padding:20px 14px}
.hdr{text-align:center;padding:22px;margin-bottom:22px;background:linear-gradient(135deg,rgba(59,130,246,.07),rgba(139,92,246,.05));border:1px solid var(--border);border-radius:14px}
.hdr h1{font-size:21px;font-weight:900;background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.hdr .sub{font-size:12px;color:var(--muted);margin-bottom:8px}
.hdr .live{display:inline-flex;align-items:center;gap:5px;font-size:10px;color:var(--dim);background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.18);padding:3px 10px;border-radius:16px}
.hdr .live .dot{width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* 5-col metrics */
.metrics{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px}
@media(max-width:768px){.metrics{grid-template-columns:repeat(2,1fr)}.metrics>.mc:last-child{grid-column:span 2}}
.mc{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
.mc .ml{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.mc .mv{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:600}
.mc .ms{font-size:10px;color:var(--muted);margin-top:2px}

.sec{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:18px}
.sh{margin-bottom:14px}
.st{font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.badge{font-size:9px;padding:2px 7px;border-radius:8px;font-weight:500}
.b-nyfed{background:rgba(16,185,129,.12);color:#34d399}
.b-poly{background:rgba(59,130,246,.12);color:#60a5fa}
.b-kalshi{background:rgba(139,92,246,.12);color:#c4b5fd}
.b-free{background:rgba(245,158,11,.12);color:#fbbf24}
.sd{font-size:10px;color:var(--dim);margin-top:3px}
.cw{position:relative;width:100%;height:280px}

.info{background:rgba(6,182,212,.04);border:1px solid rgba(6,182,212,.12);border-radius:8px;padding:12px 14px;margin-top:14px;font-size:11px;color:var(--muted);line-height:1.7}
.info b{color:var(--cyan);font-weight:600}
.info .it{font-size:12px;font-weight:700;color:var(--text);margin-bottom:5px}

.ft{width:100%;border-collapse:collapse;font-size:12px}
.ft th{text-align:left;padding:7px 8px;font-size:10px;color:var(--dim);border-bottom:1px solid var(--border);font-weight:500;text-transform:uppercase;letter-spacing:.4px}
.ft td{padding:9px 8px;border-bottom:1px solid rgba(27,35,50,.4);vertical-align:middle}
.ft tr:last-child td{border-bottom:none}
.pb{display:flex;align-items:center;gap:5px;height:20px}
.pb .bar{height:7px;border-radius:3px;min-width:2px}
.pb .pl{font-family:'JetBrains Mono',monospace;font-size:10px;min-width:32px;text-align:right}
.sb{font-size:9px;padding:2px 7px;border-radius:6px;font-weight:500;white-space:nowrap}
.s-done{background:rgba(16,185,129,.12);color:#34d399}
.s-next{background:rgba(245,158,11,.12);color:#fbbf24}
.s-future{background:rgba(100,116,139,.1);color:#94a3b8}

.pg{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.pi{background:rgba(255,255,255,.015);border:1px solid var(--border);border-radius:9px;padding:13px}
.pi .pq{font-size:12px;color:var(--text);margin-bottom:9px;line-height:1.4;font-weight:500}
.pi .pa{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.pi .pa .ol{font-size:11px}
.pi .pa .op{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600}
.pi .bt{width:100%;height:5px;background:rgba(255,255,255,.04);border-radius:3px;margin-bottom:3px;overflow:hidden}
.pi .bf{height:100%;border-radius:3px}
.src{display:flex;gap:4px;margin-top:6px}
.src span{font-size:9px;padding:1px 5px;border-radius:3px;font-weight:500}
.tp{background:#1d4ed8;color:#93c5fd}.tk{background:#5b21b6;color:#c4b5fd}

.leg{display:flex;flex-wrap:wrap;gap:12px;margin-top:10px;justify-content:center}
.leg-i{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted)}
.leg-d{width:9px;height:9px;border-radius:50%}
.nd{text-align:center;padding:30px;color:var(--dim);font-size:12px}
.foot{text-align:center;font-size:9px;color:var(--dim);margin-top:18px;padding:10px;border-top:1px solid var(--border);line-height:1.5}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <h1>ğŸ¦ Fed ê¸ˆë¦¬ ì „ë§ ëŒ€ì‹œë³´ë“œ</h1>
    <div class="sub">SOFR Â· Polymarket Â· Kalshi ì˜ˆì¸¡ ì‹œì¥ | ë¬´ë£Œ API ìë™ ì—…ë°ì´íŠ¸</div>
    <div class="live"><span class="dot"></span><span id="ts">ë¡œë”© ì¤‘...</span></div>
  </div>

  <!-- 5 Metrics -->
  <div class="metrics">
    <div class="mc"><div class="ml">í˜„ì¬ SOFR</div><div class="mv" style="color:var(--cyan)" id="m-sofr">--</div><div class="ms" id="m-sofr-d">--</div></div>
    <div class="mc"><div class="ml">Fed Funds ëª©í‘œ</div><div class="mv" style="color:var(--accent)" id="m-ff">4.25-4.50%</div><div class="ms" id="m-ff-d">í˜„ì¬ ë²”ìœ„</div></div>
    <div class="mc"><div class="ml">ë‹¤ìŒ FOMC</div><div class="mv" style="color:var(--orange)" id="m-next">--</div><div class="ms" id="m-next-d">--</div></div>
    <div class="mc"><div class="ml">ì—°ë§ ì˜ˆìƒ ê¸ˆë¦¬</div><div class="mv" style="color:var(--purple)" id="m-ye">--</div><div class="ms" id="m-ye-d">--</div></div>
    <div class="mc"><div class="ml">ì˜ˆìƒ ì¸í•˜ íšŸìˆ˜</div><div class="mv" style="color:var(--green)" id="m-cuts">--</div><div class="ms" id="m-cuts-d">Kalshi</div></div>
  </div>

  <!-- SOFR -->
  <div class="sec">
    <div class="sh"><div class="st">ğŸ“ˆ SOFR ê¸ˆë¦¬ ì¶”ì´ <span class="badge b-nyfed">NY Fed</span><span class="badge b-free">ë¬´ë£Œ</span></div><div class="sd">ë‰´ìš• ì—°ì¤€ ë°œí‘œ Secured Overnight Financing Rate</div></div>
    <div id="sofrWrap"><div class="cw"><canvas id="cSOFR"></canvas></div></div>
    <div class="info">
      <div class="it">ğŸ’¡ SOFRì´ë€?</div>
      <b>SOFR</b>(Secured Overnight Financing Rate)ì€ ë¯¸êµ­ êµ­ì±„ë¥¼ ë‹´ë³´ë¡œ í•œ í•˜ë£¨ì§œë¦¬ ëŒ€ì¶œ ê¸ˆë¦¬ë¡œ, ë‰´ìš• ì—°ì¤€ì´ ë§¤ì¼ ë°œí‘œí•©ë‹ˆë‹¤.<br>
      â€¢ <b>Fed ê¸°ì¤€ê¸ˆë¦¬ì˜ ì‹¤ì œ ì‹œì¥ ë°˜ì˜ì¹˜</b> â€” í˜„ì¬ ëª©í‘œ ë²”ìœ„(4.25~4.50%) ì¤‘ í•˜í•œì— ê·¼ì ‘í•˜ê²Œ ê±°ë˜ë©ë‹ˆë‹¤.<br>
      â€¢ SOFR ê¸‰ë“±ì€ ë‹¨ê¸° ìê¸ˆì‹œì¥ ìŠ¤íŠ¸ë ˆìŠ¤ ì‹ í˜¸ì…ë‹ˆë‹¤ (ë¶„ê¸°ë§Â·ì—°ë§ íš¨ê³¼).<br>
      â€¢ 2023ë…„ë¶€í„° LIBORë¥¼ ëŒ€ì²´í•˜ì—¬ ë¯¸êµ­ ê¸ˆìœµì‹œì¥ì˜ <b>í•µì‹¬ ê¸°ì¤€ê¸ˆë¦¬</b>ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
    </div>
  </div>

  <!-- FOMC Bar -->
  <div class="sec">
    <div class="sh"><div class="st">ğŸ¯ FOMC ë¯¸íŒ…ë³„ ê¸ˆë¦¬ ì „ë§ <span class="badge b-poly">Polymarket</span></div><div class="sd">FOMC ê³µì‹ ì¼ì • ê¸°ë°˜ Â· ì˜ˆì¸¡ì‹œì¥ í™•ë¥  ë§¤í•‘</div></div>
    <div id="fomcWrap"><div class="cw" style="height:300px"><canvas id="cFOMC"></canvas></div>
    <div class="leg">
      <div class="leg-i"><div class="leg-d" style="background:var(--dim)"></div>ë™ê²°</div>
      <div class="leg-i"><div class="leg-d" style="background:var(--accent)"></div>25bp ì¸í•˜</div>
      <div class="leg-i"><div class="leg-d" style="background:var(--cyan)"></div>50bp+ ì¸í•˜</div>
      <div class="leg-i"><div class="leg-d" style="background:var(--red)"></div>ì¸ìƒ</div>
    </div></div>
  </div>

  <!-- Rate Path -->
  <div class="sec">
    <div class="sh"><div class="st">ğŸ“‰ ì˜ˆìƒ ê¸ˆë¦¬ ê²½ë¡œ <span class="badge b-poly">Polymarket</span></div><div class="sd">ì˜ˆì¸¡ì‹œì¥ í™•ë¥  â†’ ë‚´ì¬ ê¸ˆë¦¬ ê²½ë¡œ</div></div>
    <div id="pathWrap"><div class="cw"><canvas id="cPath"></canvas></div></div>
    <div class="info">
      <div class="it">ğŸ“ ê³„ì‚° ë°©ë²•</div>
      ê° FOMCì˜ ê¸°ëŒ€ ë³€ë™ = (25bpì¸í•˜ í™•ë¥  Ã— -0.25) + (50bpì¸í•˜ í™•ë¥  Ã— -0.50) + (ì¸ìƒ í™•ë¥  Ã— +0.25)<br>
      í˜„ì¬ ê¸ˆë¦¬ì—ì„œ ëˆ„ì í•˜ì—¬ ê²½ë¡œë¥¼ ì¶”ì •í•©ë‹ˆë‹¤. ì˜ˆì¸¡ ë°ì´í„° ì—†ëŠ” ë¯¸íŒ…ì€ ë™ê²°ë¡œ ê°€ì •í•©ë‹ˆë‹¤.
    </div>
  </div>

  <!-- FOMC Table -->
  <div class="sec">
    <div class="sh"><div class="st">ğŸ“‹ FOMC ë¯¸íŒ… ì„¸ë¶€ í™•ë¥ </div><div class="sd">ì—°ì¤€ ê³µì‹ ì¼ì • ê¸°ë°˜</div></div>
    <div style="overflow-x:auto"><table class="ft"><thead><tr><th>ë¯¸íŒ…</th><th>ë‚ ì§œ</th><th>ìƒíƒœ</th><th>ë™ê²°</th><th>25bp ì¸í•˜</th><th>50bp+ ì¸í•˜</th><th>ì¸ìƒ</th></tr></thead><tbody id="tBody"></tbody></table></div>
  </div>

  <!-- Pred Grid -->
  <div class="sec">
    <div class="sh"><div class="st">ğŸ”® ì£¼ìš” ê¸ˆë¦¬ ì˜ˆì¸¡ ë§ˆì¼“</div><div class="sd">Polymarket & Kalshi í™œì„± ë§ˆì¼“</div></div>
    <div class="pg" id="pGrid"></div>
  </div>

  <div class="foot">
    âš ï¸ ë³¸ ëŒ€ì‹œë³´ë“œëŠ” ì •ë³´ ì œê³µ ëª©ì ì´ë©°, íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤.<br>
    ë°ì´í„°: NY Fed Â· Polymarket Â· Kalshi (ëª¨ë‘ ë¬´ë£Œ API)
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â• ë²ˆì—­ â•â•â•â•â•â•â•â•â•â•â•
const MO_KO={1:"1ì›”",2:"2ì›”",3:"3ì›”",4:"4ì›”",5:"5ì›”",6:"6ì›”",7:"7ì›”",8:"8ì›”",9:"9ì›”",10:"10ì›”",11:"11ì›”",12:"12ì›”"};
const MO_EN={january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12};

function toKo(s){if(!s)return s;let t=s;
t=t.replace(/will no rate cuts? happen in (\d{4})\??/gi,(_,y)=>`${y}ë…„ ê¸ˆë¦¬ ì¸í•˜ 0íšŒ ì—¬ë¶€`);
t=t.replace(/will (\d+) or more rate cuts? happen in (\d{4})\??/gi,(_,n,y)=>`${y}ë…„ ${n}íšŒ ì´ìƒ ê¸ˆë¦¬ ì¸í•˜ ì—¬ë¶€`);
t=t.replace(/will fewer than (\d+) rate cuts? happen in (\d{4})\??/gi,(_,n,y)=>`${y}ë…„ ${n}íšŒ ë¯¸ë§Œ ê¸ˆë¦¬ ì¸í•˜ ì—¬ë¶€`);
t=t.replace(/will at least (\d+) rate cuts? happen in (\d{4})\??/gi,(_,n,y)=>`${y}ë…„ ìµœì†Œ ${n}íšŒ ê¸ˆë¦¬ ì¸í•˜ ì—¬ë¶€`);
t=t.replace(/will (\d+) rate cuts? happen in (\d{4})\??/gi,(_,n,y)=>`${y}ë…„ ${n}íšŒ ê¸ˆë¦¬ ì¸í•˜ ì—¬ë¶€`);
t=t.replace(/how many (?:fed )?rate cuts? (?:in )?(\d{4})\??/gi,(_,y)=>`${y}ë…„ Fed ê¸ˆë¦¬ ì¸í•˜ íšŸìˆ˜`);
for(const[en,num]of Object.entries(MO_EN)){t=t.replace(new RegExp(`Fed [Dd]ecision in ${en}\\??`,"gi"),`${MO_KO[num]} FOMC ê¸ˆë¦¬ ê²°ì •`);}
t=t.replace(/what will the fed (?:funds )?rate be at the end of (\d{4})\??/gi,(_,y)=>`${y}ë…„ ë§ Fed ê¸°ì¤€ê¸ˆë¦¬ ì „ë§`);
t=t.replace(/will the fed (?:raise|hike) rates?.*?(\d{4})\??/gi,(_,y)=>`${y}ë…„ Fed ê¸ˆë¦¬ ì¸ìƒ ì—¬ë¶€`);
t=t.replace(/will the fed cut rates?.*?(\d{4})\??/gi,(_,y)=>`${y}ë…„ Fed ê¸ˆë¦¬ ì¸í•˜ ì—¬ë¶€`);
return t;}

function oKo(o){const m={"Yes":"ì˜ˆ","No":"ì•„ë‹ˆì˜¤","No change":"ë™ê²°","25 bps decrease":"25bp ì¸í•˜","25 bps cut":"25bp ì¸í•˜","50 bps decrease":"50bp ì¸í•˜","50 bps cut":"50bp ì¸í•˜","75 bps decrease":"75bp ì¸í•˜","25 bps increase":"25bp ì¸ìƒ","50 bps increase":"50bp ì¸ìƒ","Increase":"ì¸ìƒ","Decrease":"ì¸í•˜"};
if(m[o])return m[o];let r;
if(r=o.match(/(\d+)\s*bps?\s*(decrease|cut)/i))return`${r[1]}bp ì¸í•˜`;
if(r=o.match(/(\d+)\s*bps?\s*(increase|hike)/i))return`${r[1]}bp ì¸ìƒ`;
if(r=o.match(/(\d+\.\d+)\s*[-â€“]\s*(\d+\.\d+)/))return`${r[1]}~${r[2]}%`;
if(r=o.match(/(\d+)\s*cuts?/i))return`${r[1]}íšŒ ì¸í•˜`;
if(r=o.match(/(\d+)\s*or more/i))return`${r[1]}íšŒ ì´ìƒ`;
return o;}

// â•â•â•â•â•â•â•â•â•â•â• Data â•â•â•â•â•â•â•â•â•â•â•
async function loadData(){
  try{const r=await fetch("data/rate_data.json");if(r.ok){const j=await r.json();if(j.fomc_calendar?.length||j.sofr?.length)return j;}}catch(_){}
  return {meta:{updated_at:new Date().toISOString()},fomc_calendar:[],sofr:[],polymarket:{fomc_decisions:[],other_markets:[]},kalshi:{}};
}

// â•â•â•â•â•â•â•â•â•â•â• FOMC Calendar + Polymarket merge â•â•â•â•â•â•â•â•â•â•â•
function buildFOMC(cal, polyFomc){
  const now=new Date(), yr=now.getFullYear();

  // Polymarket â†’ month ì¸ë±ìŠ¤ (endDate ê¸°ë°˜)
  const pByKey={};
  for(const ev of polyFomc){
    const tl=ev.title.toLowerCase();
    let mo=null;
    for(const[en,num]of Object.entries(MO_EN)){if(tl.includes(en)){mo=num;break;}}
    if(!mo)continue;
    let eyr=yr;
    if(ev.endDate){try{eyr=new Date(ev.endDate).getFullYear();}catch(_){}}
    pByKey[`${eyr}-${mo}`]=ev;
  }

  const meetings=[];
  for(const c of cal){
    const key=`${c.year}-${c.month}`;
    const pev=pByKey[key]||null;
    const endD=new Date(c.end_date+"T23:59:59Z");
    const past=endD<now;
    let nc=0,c25=0,c50=0,hk=0,has=false;

    if(pev){
      has=true;
      for(const m of pev.markets){
        const oc=m.outcomes_en||m.outcomes_ko||[];
        oc.forEach((o,i)=>{
          const ol=o.toLowerCase(),p=(m.prices[i]||0)*100;
          if(ol.includes("no change")||ol==="ë™ê²°")nc=Math.max(nc,p);
          else if((ol.includes("25")&&(ol.includes("decrease")||ol.includes("cut")))||ol==="25bp ì¸í•˜")c25=Math.max(c25,p);
          else if((ol.includes("50")&&(ol.includes("decrease")||ol.includes("cut")))||ol==="50bp ì¸í•˜")c50=Math.max(c50,p);
          else if(ol.includes("hike")||ol.includes("increase")||ol==="ì¸ìƒ")hk=Math.max(hk,p);
        });
      }
    }

    let lbl=MO_KO[c.month];
    if(c.year!==yr)lbl+=` '${String(c.year).slice(2)}`;
    const dd=c.date.split("-");
    const ed=c.end_date.split("-");

    meetings.push({
      title:lbl, dateLabel:`${+dd[1]}/${+dd[2]}-${+ed[2]}`,
      year:c.year, month:c.month,
      noChange:Math.round(nc), cut25:Math.round(c25), cut50:Math.round(c50), hike:Math.round(hk),
      hasData:has, isPast:past,
    });
  }

  // ì˜¬í•´ + ë‹¤ìŒí•´ ì²« 2ê°œ
  const thisY=meetings.filter(m=>m.year===yr);
  const nextY=meetings.filter(m=>m.year===yr+1).slice(0,2);
  const all=[...thisY,...nextY];

  const fi=all.findIndex(m=>!m.isPast);
  all.forEach((m,i)=>{m.status=m.isPast?"done":i===fi?"next":"future";});
  return all;
}

// â•â•â•â•â•â•â•â•â•â•â• Kalshi Cut Count â•â•â•â•â•â•â•â•â•â•â•
function parseCutCount(kalshi){
  const mkts=kalshi?.KXRATECUTCOUNT||[];
  if(!mkts.length)return null;
  // ê° ë§ˆì¼“ì˜ subtitleì—ì„œ íšŸìˆ˜ ì¶”ì¶œ, last_priceë¡œ í™•ë¥ 
  const items=[];
  for(const m of mkts){
    const p=m.last_price||m.yes_bid||0;
    if(!p)continue;
    // subtitle: "2 or more cuts" / "Exactly 1 cut" / "0 cuts" ë“±
    let label=m.subtitle_ko||toKo(m.subtitle)||m.subtitle||m.title_ko||toKo(m.title)||m.title;
    items.push({label, pct:p, volume:m.volume||0, ticker:m.ticker});
  }
  items.sort((a,b)=>b.pct-a.pct);
  return items;
}

function parseOtherMarkets(polyOther, kalshi){
  const items=[];
  for(const ev of polyOther){
    for(const m of ev.markets){
      if(!m.prices.length)continue;
      const oc=m.outcomes_en||[];
      items.push({question:toKo(m.question_en||ev.title),outcomes:oc.map((o,i)=>({label:oKo(o),pct:Math.round((m.prices[i]||0)*100)})),source:"polymarket",volume:m.volume});
    }
  }
  // Kalshi KXRATECUTCOUNT â†’ ê·¸ë¦¬ë“œì—ë„ ì¶”ê°€
  const cutMkts=kalshi?.KXRATECUTCOUNT||[];
  for(const m of cutMkts){
    const p=m.last_price||m.yes_bid||0;
    if(!p)continue;
    const title=toKo(m.title||"")+(m.subtitle?" â€” "+toKo(m.subtitle):"");
    items.push({question:title,outcomes:[{label:"ì˜ˆ",pct:p},{label:"ì•„ë‹ˆì˜¤",pct:100-p}],source:"kalshi",volume:m.volume||0});
  }
  // Kalshi KXFED
  const fedMkts=kalshi?.KXFED||[];
  for(const m of fedMkts){
    const p=m.last_price||m.yes_bid||0;
    if(!p)continue;
    items.push({question:toKo(m.title||""),outcomes:[{label:"ì˜ˆ",pct:p},{label:"ì•„ë‹ˆì˜¤",pct:100-p}],source:"kalshi",volume:m.volume||0});
  }
  items.sort((a,b)=>(b.volume||0)-(a.volume||0));
  return items.slice(0,8);
}

// â•â•â•â•â•â•â•â•â•â•â• Charts â•â•â•â•â•â•â•â•â•â•â•
Chart.defaults.color='#94a3b8';Chart.defaults.borderColor='#1a2332';
Chart.defaults.font.family="'Noto Sans KR','JetBrains Mono',sans-serif";Chart.defaults.font.size=11;
const C={};

function drawSOFR(d){
  if(!d.length)return;
  const ctx=document.getElementById("cSOFR").getContext("2d");
  if(C.s)C.s.destroy();
  C.s=new Chart(ctx,{type:"line",
    data:{labels:d.map(x=>{const t=new Date(x.date);return`${t.getMonth()+1}/${t.getDate()}`}),
      datasets:[{data:d.map(x=>x.rate),borderColor:"#06b6d4",backgroundColor:"rgba(6,182,212,.08)",borderWidth:2,fill:true,tension:.3,pointRadius:0,pointHoverRadius:5,pointHoverBackgroundColor:"#06b6d4"}]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:"index",intersect:false},
      plugins:{legend:{display:false},tooltip:{backgroundColor:"#1e293b",borderColor:"#334155",borderWidth:1,padding:8,callbacks:{label:c=>`SOFR: ${c.raw.toFixed(3)}%`}}},
      scales:{x:{grid:{display:false},ticks:{maxTicksLimit:8,font:{size:10}}},y:{grid:{color:"#1a2332"},ticks:{callback:v=>v.toFixed(2)+"%",font:{size:10}}}}}
  });
}

function drawFOMC(fomc){
  const f=fomc.filter(m=>!m.isPast);
  if(!f.length){document.getElementById("fomcWrap").innerHTML='<div class="nd">ì˜ˆì¸¡ ë°ì´í„° ì—†ìŒ</div>';return;}
  const ctx=document.getElementById("cFOMC").getContext("2d");
  if(C.f)C.f.destroy();
  C.f=new Chart(ctx,{type:"bar",
    data:{labels:f.map(m=>m.hasData?m.title:m.title+"\n(ë¯¸ì •)"),
      datasets:[
        {label:"ë™ê²°",data:f.map(m=>m.noChange),backgroundColor:f.map(m=>m.hasData?"#475569":"#2a3040"),borderRadius:3,barPercentage:.7},
        {label:"25bp ì¸í•˜",data:f.map(m=>m.cut25),backgroundColor:f.map(m=>m.hasData?"#3b82f6":"#1e3a5f"),borderRadius:3,barPercentage:.7},
        {label:"50bp+ ì¸í•˜",data:f.map(m=>m.cut50),backgroundColor:f.map(m=>m.hasData?"#06b6d4":"#0a4a54"),borderRadius:3,barPercentage:.7},
        {label:"ì¸ìƒ",data:f.map(m=>m.hike),backgroundColor:f.map(m=>m.hasData?"#ef4444":"#5a2020"),borderRadius:3,barPercentage:.7},
      ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{backgroundColor:"#1e293b",borderColor:"#334155",borderWidth:1,padding:8,callbacks:{label:c=>c.raw?`${c.dataset.label}: ${c.raw}%`:''}}},
      scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10}}},y:{stacked:true,max:100,grid:{color:"#1a2332"},ticks:{callback:v=>v+"%",font:{size:10}}}}}
  });
}

function drawPath(fomc){
  const f=fomc.filter(m=>!m.isPast);
  if(!f.length){document.getElementById("pathWrap").innerHTML='<div class="nd">ê²½ë¡œ ë°ì´í„° ì—†ìŒ</div>';return;}
  let u=4.50;
  const p=[{l:"í˜„ì¬",u,lo:u-.25}];
  for(const m of f){
    const e=m.hasData?(m.cut25*-.25+m.cut50*-.5+m.hike*.25)/100:0;
    u=Math.round((u+e)*100)/100;
    p.push({l:m.title,u,lo:u-.25});
  }
  const ctx=document.getElementById("cPath").getContext("2d");
  if(C.p)C.p.destroy();
  C.p=new Chart(ctx,{type:"line",
    data:{labels:p.map(x=>x.l),
      datasets:[
        {label:"ë‚´ì¬ ê¸ˆë¦¬ ìƒí•œ",data:p.map(x=>x.u),borderColor:"#3b82f6",backgroundColor:"rgba(59,130,246,.06)",borderWidth:2.5,fill:true,tension:.4,pointRadius:5,pointBackgroundColor:"#3b82f6",pointBorderColor:"#0d1117",pointBorderWidth:2},
        {label:"ë‚´ì¬ ê¸ˆë¦¬ í•˜í•œ",data:p.map(x=>x.lo),borderColor:"#8b5cf6",backgroundColor:"rgba(139,92,246,.06)",borderWidth:2,borderDash:[5,5],fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#8b5cf6",pointBorderColor:"#0d1117",pointBorderWidth:2},
      ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:"index",intersect:false},
      plugins:{legend:{position:"bottom",labels:{boxWidth:10,padding:14,font:{size:10},usePointStyle:true}},tooltip:{backgroundColor:"#1e293b",borderColor:"#334155",borderWidth:1,padding:8,callbacks:{label:c=>`${c.dataset.label}: ${c.raw.toFixed(2)}%`}}},
      scales:{x:{grid:{display:false},ticks:{font:{size:10}}},y:{grid:{color:"#1a2332"},ticks:{callback:v=>v.toFixed(2)+"%",stepSize:.25,font:{size:10}},suggestedMin:2.5}}}
  });
}

function drawTable(fomc){
  const tb=document.getElementById("tBody");
  if(!fomc.length){tb.innerHTML='<tr><td colspan="7" class="nd">ë°ì´í„° ì—†ìŒ</td></tr>';return;}
  tb.innerHTML=fomc.map(f=>{
    const sc=f.status==="done"?"s-done":f.status==="next"?"s-next":"s-future";
    const sl=f.status==="done"?"ì™„ë£Œ":f.status==="next"?"ë‹¤ìŒ":"ì˜ˆì •";
    if(!f.hasData&&!f.isPast)
      return`<tr style="opacity:.45"><td style="font-weight:500">${f.title}</td><td style="font-size:11px;color:var(--dim)">${f.dateLabel}</td><td><span class="sb ${sc}">${sl}</span></td><td colspan="4" style="text-align:center;color:var(--dim);font-size:11px">ì˜ˆì¸¡ ë°ì´í„° ëŒ€ê¸°</td></tr>`;
    const bar=(p,c)=>`<div class="pb"><div class="bar" style="width:${Math.max(p,1)}%;background:${c}"></div><span class="pl" style="color:${c}">${p}%</span></div>`;
    return`<tr><td style="font-weight:500">${f.title}</td><td style="font-size:11px;color:var(--dim)">${f.dateLabel}</td><td><span class="sb ${sc}">${sl}</span></td><td>${bar(f.noChange,"#64748b")}</td><td>${bar(f.cut25,"#3b82f6")}</td><td>${bar(f.cut50,"#06b6d4")}</td><td>${bar(f.hike,"#ef4444")}</td></tr>`;
  }).join("");
}

function drawGrid(items){
  const g=document.getElementById("pGrid");
  if(!items.length){g.innerHTML='<div class="nd" style="grid-column:1/-1">í™œì„± ë§ˆì¼“ ì—†ìŒ</div>';return;}
  const cl=["var(--accent)","var(--purple)","var(--cyan)","var(--orange)","var(--green)","var(--pink)"];
  g.innerHTML=items.map(x=>{
    const src=x.source==="polymarket"?'<span class="tp">Polymarket</span>':'<span class="tk">Kalshi</span>';
    return`<div class="pi"><div class="pq">${x.question}</div>${x.outcomes.slice(0,4).map((o,i)=>`<div class="pa"><span class="ol">${o.label}</span><span class="op" style="color:${cl[i%cl.length]}">${o.pct}%</span></div><div class="bt"><div class="bf" style="width:${o.pct}%;background:${cl[i%cl.length]}"></div></div>`).join("")}<div class="src">${src}</div></div>`;
  }).join("");
}

// â•â•â•â•â•â•â•â•â•â•â• Metrics â•â•â•â•â•â•â•â•â•â•â•
function updateMetrics(sofr, fomc, cuts, otherMkts, data){
  // SOFR
  if(sofr.length){
    const l=sofr[sofr.length-1];
    document.getElementById("m-sofr").textContent=l.rate.toFixed(2)+"%";
    document.getElementById("m-sofr-d").textContent=l.date;
  }
  // Next FOMC
  const next=fomc.find(f=>f.status==="next");
  if(next){
    if(next.hasData){
      const top=next.noChange>=Math.max(next.cut25,next.cut50)?"ë™ê²°":"ì¸í•˜";
      const pct=Math.max(next.noChange,next.cut25,next.cut50);
      document.getElementById("m-next").textContent=top+" "+pct+"%";
    }else{
      document.getElementById("m-next").textContent=next.title;
    }
    document.getElementById("m-next-d").textContent=next.title+" ("+next.dateLabel+")";
  }
  // Year-end
  const ye=otherMkts.find(m=>m.question.includes("ë§")||m.question.toLowerCase().includes("end of"));
  if(ye&&ye.outcomes.length){
    const t=ye.outcomes.reduce((a,b)=>b.pct>a.pct?b:a,ye.outcomes[0]);
    document.getElementById("m-ye").textContent=t.label;
    document.getElementById("m-ye-d").textContent=`${t.pct}% í™•ë¥ `;
  }
  // Cut count (Kalshi)
  if(cuts&&cuts.length){
    const top=cuts[0]; // ê°€ì¥ í™•ë¥  ë†’ì€ ê²ƒ
    document.getElementById("m-cuts").textContent=top.pct+"%";
    document.getElementById("m-cuts-d").textContent=top.label;
  }
  // Timestamp
  const ts=data.meta?.updated_at||new Date().toISOString();
  const d=new Date(ts);
  document.getElementById("ts").textContent=`${d.toLocaleDateString("ko-KR")} ${d.toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})} ì—…ë°ì´íŠ¸`;
}

// â•â•â•â•â•â•â•â•â•â•â• Init â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  try{
    const data=await loadData();
    const sofr=data.sofr||[];
    const fomc=buildFOMC(data.fomc_calendar||[], data.polymarket?.fomc_decisions||[]);
    const cuts=parseCutCount(data.kalshi||{});
    const other=parseOtherMarkets(data.polymarket?.other_markets||[], data.kalshi||{});
    updateMetrics(sofr,fomc,cuts,other,data);
    drawSOFR(sofr);drawFOMC(fomc);drawPath(fomc);drawTable(fomc);drawGrid(other);
  }catch(e){console.error(e);document.getElementById("ts").textContent="ë¡œë“œ ì‹¤íŒ¨: "+e.message;}
}
init();
</script>
</body>
</html>
